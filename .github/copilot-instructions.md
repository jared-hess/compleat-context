# Copilot Instructions for compleat-context

## Project Overview

This is a Python 3.12 CLI tool that downloads and processes Magic: The Gathering card data from Scryfall. The project creates GPT-optimized CSV files with comprehensive card information including pricing, legality, and metadata.

## Technology Stack

- **Language**: Python 3.12
- **Package Manager**: Poetry
- **CLI Framework**: Click
- **Data Processing**: Pandas
- **HTTP Client**: Requests
- **Testing**: pytest with pytest-mock
- **Code Quality**: black (formatting), ruff (linting), mypy (type checking)

## Code Style and Quality

### Formatting
- Use **black** for code formatting with line length 88
- Target Python 3.12 syntax
- Run `poetry run black .` before committing

### Linting
- Use **ruff** for linting with auto-fix enabled
- Selected rules: E, F, I, N, W, UP
- Run `poetry run ruff check .` to validate

### Type Checking
- Use **mypy** in strict mode
- All functions must have type annotations (`disallow_untyped_defs = true`)
- Run `poetry run mypy ccx` to validate

### Pre-commit Hooks
- Install with `poetry run pre-commit install`
- Hooks run automatically: black, ruff, mypy
- Run manually: `poetry run pre-commit run --all-files`

## Testing Requirements

- Use **pytest** for all tests
- Place tests in the `tests/` directory
- Name test files with `test_*.py` prefix
- Use `pytest-mock` for mocking when needed
- Run tests: `poetry run pytest -v`
- All code changes must include relevant tests
- Tests must pass before code is merged

## Dependency Management

- Use **Poetry** for all dependency management
- Add dependencies: `poetry add <package>`
- Add dev dependencies: `poetry add --group dev <package>`
- Never modify `pyproject.toml` or `poetry.lock` manually
- Run `poetry install` after pulling changes

## Build Commands

### Main Build
```bash
poetry run ccx build
```

This downloads Scryfall data and generates processed CSV files in `data/`.

### Development Setup
```bash
poetry install
poetry run pre-commit install
```

## Project Structure

- `ccx/` - Main package
  - `cli.py` - CLI entry point
  - `commands/` - Command implementations
    - `build.py` - Main build logic for Scryfall data processing
- `tests/` - Test suite
- `data/` - Output directory for processed CSV files
- `.github/workflows/` - CI/CD automation

## Data Processing Pipeline

The build process:
1. Downloads Scryfall oracle cards and default cards (for pricing)
2. Merges oracle text for double-faced cards (DFCs)
3. Aggregates pricing information across printings
4. Converts arrays/objects to JSON strings for GPT compatibility
5. Adds flat fields optimized for LLM/CSV consumption
6. Splits large files (>50MB) alphabetically (a-f, g-n, o-z)
7. Generates `manifest.json` with build metadata

### GPT-Friendly Fields
When working with data processing code:
- Convert lists/dicts to JSON strings (double-quoted, compact)
- Add flat string fields for colors (`colors_str`, `color_identity_str`)
- Create semicolon-joined keywords (`keywords_joined`)
- Generate individual legality fields (`legal_standard`, `legal_modern`, etc.)
- Build human-readable summaries (`legal_summary`, `price_summary`)

## CI/CD

- **CI workflow** (`ci.yml`): Runs on push/PR - lint, format, type check, tests
- **Nightly workflow** (`nightly.yml`): Daily data refresh at 2 AM UTC

## Common Patterns

### Adding a New CLI Command
1. Create command function in `ccx/commands/`
2. Add type annotations and docstrings
3. Register in `ccx/cli.py` using `@cli.command()`
4. Add tests in `tests/`

### Modifying Data Processing
1. Update logic in `ccx/commands/build.py`
2. Ensure backward compatibility with existing CSV structure
3. Update tests to cover new behavior
4. Consider impact on file splitting and GPT compatibility

## Important Notes

- This project processes external data from Scryfall API
- Data files in `data/` directory are regenerated by CI
- License: MIT
- Not affiliated with Wizards of the Coast or Scryfall
- Card data is from Scryfall under CC BY 4.0 license

## Getting Help

- Review existing tests in `tests/` for examples
- Check `README.md` for user-facing documentation
- Review CI workflows in `.github/workflows/` for automation patterns
